# API利用制限設定

## 概要

βテスト期間中のAPI費用管理のため、1日あたりのメッセージ送信回数に制限を設けています。

## 現在の設定

| 項目 | 値 | 備考 |
|------|-----|------|
| 1日の上限 | **40回** | 1往復（ユーザー送信→AI応答）で1回カウント |
| リセット時刻 | **日本時間0時** | UTC+9 |
| 対象モデル | Gemini 2.5 Flash | `lib/ai-service.ts` で設定 |

## コスト見積もり

### 1ユーザーあたり

| 項目 | 値 |
|------|-----|
| 1リクエストの入力トークン | 約1,550トークン（プラン3適用後） |
| 1リクエストの出力トークン | 約1,000トークン |
| 1日40回の推定コスト | **約5円** |
| 月額（毎日MAX利用） | **約150円** |

### Gemini 2.5 Flash料金

| 項目 | 料金 |
|------|------|
| 入力 | $0.15 / 100万トークン |
| 出力 | $0.60 / 100万トークン |

## 関連ファイル

```
lib/
├── usage-config.ts          # 制限設定の定数
└── firebase/
    └── firestore.ts         # 利用回数の保存・取得関数

app/
└── dashboard/
    └── page.tsx             # 制限チェックとUI表示
```

## Firestoreデータ構造

```typescript
// コレクション: userUsage
// ドキュメントID: userId
{
  date: "2025-01-19",      // 日付（YYYY-MM-DD）
  count: 15,               // 今日の利用回数
  updatedAt: Timestamp     // 最終更新日時
}
```

## 設定変更方法

`lib/usage-config.ts` を編集:

```typescript
export const USAGE_LIMITS = {
  // この値を変更
  DAILY_MESSAGE_LIMIT: 40,  // 1日あたりの最大往復回数
  RESET_HOUR_JST: 0,        // リセット時刻（日本時間）
} as const;
```

## 変更履歴

| 日付 | 変更内容 | 理由 |
|------|----------|------|
| 2025-01-19 | 初期実装: 1日40回制限 | βテスト開始、コスト管理 |

## 今後の予定

- [ ] 有料プラン導入時に制限緩和/撤廃
- [ ] プラン別の制限設定（フリー/スタンダード/プレミアム）
- [ ] 管理画面からの制限変更機能

## 注意事項

- 制限はFirestoreに保存されるため、ブラウザを変えても共有される
- 日付はJST基準でリセットされる
- 制限到達時はAIが「上限に達しました」メッセージを返す（APIは呼ばない）
